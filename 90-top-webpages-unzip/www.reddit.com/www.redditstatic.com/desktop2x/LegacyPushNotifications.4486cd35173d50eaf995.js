(window.webpackJsonp=window.webpackJsonp||[]).push([["PushNotifications"],{"./node_modules/core-js/modules/_string-repeat.js":function(e,t,n){"use strict";var r=n("./node_modules/core-js/modules/_to-integer.js"),s=n("./node_modules/core-js/modules/_defined.js");e.exports=function(e){var t=String(s(this)),n="",o=r(e);if(o<0||o==1/0)throw RangeError("Count can't be negative");for(;o>0;(o>>>=1)&&(t+=t))1&o&&(n+=t);return n}},"./node_modules/core-js/modules/es6.string.repeat.js":function(e,t,n){var r=n("./node_modules/core-js/modules/_export.js");r(r.P,"String",{repeat:n("./node_modules/core-js/modules/_string-repeat.js")})},"./src/graphql/operations/RegisterWebPushToken.json":function(e){e.exports=JSON.parse('{"id":"197650c1946c"}')},"./src/lib/timezone/index.ts":function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return a})),n.d(t,"e",(function(){return c})),n.d(t,"d",(function(){return u})),n.d(t,"f",(function(){return d})),n.d(t,"g",(function(){return l})),n.d(t,"c",(function(){return p}));n("./node_modules/core-js/modules/es6.number.constructor.js"),n("./node_modules/core-js/modules/es6.regexp.replace.js"),n("./node_modules/core-js/modules/es6.regexp.split.js");var r=n("./node_modules/@babel/runtime/helpers/esm/slicedToArray.js"),s=n("./src/lib/constants/index.ts"),o=n("./src/reddit/models/PostCreationForm/index.ts"),i="America/Los_Angeles",a=function(){var e;try{e=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}return"Asia/Calcutta"===e&&(e="Asia/Kolkata"),e||void 0},c=function(e){var t=Math.abs(e),n=t%60,r=e>0?"-":"+",s=("0"+Math.floor(t/60)).slice(-2),o=("0"+n).slice(-2);return"".concat(r).concat(s,":").concat(o)},u=function(e,t){var n=t||Date.now(),o={year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",timeZoneName:"short",hour12:!1,timeZone:e},i="";try{i=new Intl.DateTimeFormat("en-US",o).format(new Date(n))}catch(e){return}var a=i.replace(", "," ").split(" "),c=Object(r.a)(a,3),u=c[0],d=c[1],l=c[2],p=u.trim().split("/").map(Number),f=Object(r.a)(p,3),b=f[0],m=f[1],g=f[2],j=d.trim().split(":").map(Number),v=Object(r.a)(j,3),k=v[0],O=v[1],h=v[2],x=Date.UTC(g,b-1,m,k,O,h),_=new Date(n).setMilliseconds(0)-x;return{abbreviation:l,offset:Math.round(_/s.bb)}},d=function(e){var t=e.slice(0,19).split("T"),n=Object(r.a)(t,2),s=n[0],o=n[1],i=s.split("-").map(Number),a=Object(r.a)(i,3),c=a[0],u=a[1],d=a[2],l=o.split(":").map(Number),p=Object(r.a)(l,3),f=p[0],b=p[1],m=p[2];return new Date(c,u-1,d,f,b,void 0===m?0:m)},l=function(e){var t=new Date(e);return t.setMinutes(t.getMinutes()-t.getTimezoneOffset()),t.toISOString().slice(0,16)},p=function(e){if(e&&e.eventInfo){var t=e.eventInfo,n=t.eventStart,r=t.eventEnd;return{startDate:l(new Date(n*s.Ab)),endDate:l(new Date(r*s.Ab)),submitTime:o.i.Now,timezoneName:a()||i}}}},"./src/reddit/actions/notifications/index.ts":function(e,t,n){"use strict";n.r(t);n("./node_modules/core-js/modules/es6.regexp.to-string.js"),n("./node_modules/core-js/modules/es6.object.to-string.js");var r=n("./node_modules/@babel/runtime/regenerator/index.js"),s=n.n(r),o=(n("./node_modules/regenerator-runtime/runtime.js"),n("./node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js")),i=n("./src/config.ts"),a=n("./src/lib/browser/isIncognito.ts"),c=n("./src/lib/constants/index.ts"),u=n("./src/lib/localStorageAvailable/index.ts"),d=(n("./node_modules/core-js/modules/es6.typed.uint8-array.js"),n("./node_modules/core-js/modules/es6.regexp.replace.js"),n("./node_modules/core-js/modules/es6.string.repeat.js"),function(e){for(var t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=window.atob(t),r=new Uint8Array(n.length),s=0;s<n.length;++s)r[s]=n.charCodeAt(s);return r}),l=n("./src/reddit/actions/notifications/constants.ts"),p=n("./src/reddit/actions/notifications/state.ts"),f=n("./src/reddit/actions/notifications/utils.ts"),b=n("./src/reddit/actions/toaster.ts"),m=(n("./node_modules/core-js/modules/es6.object.assign.js"),n("./src/graphql/operations/RegisterWebPushToken.json")),g=n("./src/lib/makeGqlRequest/index.ts"),j=n("./src/lib/timezone/index.ts"),v=function(e,t,n){var r={pushToken:JSON.stringify(n),timezoneName:Object(j.b)()||j.a,timestamp:(new Date).toISOString(),language:"en_us"};return Object(g.a)(e,Object.assign({},m,{variables:r}))},k=n("./src/reddit/helpers/trackers/notifications.ts"),O=n("./src/reddit/i18n/utils.ts"),h=n("./src/reddit/models/Toast/index.ts"),x=n("./src/reddit/selectors/experiments/dnPrePrompt.ts"),_=n("./src/reddit/selectors/notificationPrefs.ts"),w=n("./src/reddit/selectors/user.ts");n.d(t,"getBrowserNotificationPermission",(function(){return S})),n.d(t,"resetPermissionRequestClosed",(function(){return y})),n.d(t,"isBrowserSubscribedForPushNotifications",(function(){return N})),n.d(t,"initializeServiceWorkerChannel",(function(){return I})),n.d(t,"requestNotificationsPermissions",(function(){return q})),n.d(t,"subscribeForPNs",(function(){return M})),n.d(t,"unsubscribeFromPNs",(function(){return A}));var P=4*c.I,S=function(){var e=Object(u.a)()&&"1"===localStorage.getItem("notification-permission-request-closed");return"granted"===Notification.permission?l.a.Granted:"denied"===Notification.permission?l.a.Denied:e?l.a.Closed:l.a.Default},y=function(){return!!Object(u.a)()&&(localStorage.removeItem("notification-permission-request-closed"),!0)},N=function(){var e=Object(o.a)(s.a.mark((function e(){var t,n;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.serviceWorker.register("/sw.js");case 3:t=e.sent,e.next=9;break;case 6:return e.prev=6,e.t0=e.catch(0),e.abrupt("return",!1);case 9:return e.next=11,t.pushManager.getSubscription();case 11:return n=e.sent,e.abrupt("return",null!==n);case 13:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(){return e.apply(this,arguments)}}(),C=function(e){navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage({command:"registerClient",v2EventBoilerPlate:k.b(e)})},D=!1,I=function(){var e=Object(o.a)(s.a.mark((function e(t){var n;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!D){e.next=2;break}return e.abrupt("return");case 2:if(D=!0,Object(f.a)(t)===l.f.NotificationsSupported){e.next=6;break}return e.abrupt("return");case 6:return e.prev=6,e.next=9,navigator.serviceWorker.register("/sw.js");case 9:e.next=14;break;case 11:return e.prev=11,e.t0=e.catch(6),e.abrupt("return");case 14:n=function(e){"registerWithServiceWorker"===e.data.command&&C(t)},navigator.serviceWorker.addEventListener("message",n),C(t);case 17:case"end":return e.stop()}}),e,null,[[6,11]])})));return function(t){return e.apply(this,arguments)}}(),q=function(e,t){return function(){var n=Object(o.a)(s.a.mark((function n(r,o,i){var c,d,p,b,m,g,j,v;return s.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return c=o(),n.next=3,Object(a.a)();case 3:if(!n.sent){n.next=5;break}return n.abrupt("return");case 5:if(d=Object(x.a)(c),Object(w.G)(c)||d){n.next=8;break}return n.abrupt("return");case 8:return n.next=10,I(c);case 10:if(!Object(u.a)()){n.next=16;break}if(p=localStorage.getItem("push-token-last-refresh-ms"),b=(new Date).getTime(),!(!e&&p&&parseInt(p)+P>b)){n.next=15;break}return n.abrupt("return");case 15:localStorage.setItem("push-token-last-refresh-ms",b.toString());case 16:if(k.l(c),(m=Object(f.a)(c))!==l.f.BrowserUnsupported){n.next=23;break}return k.k(c,"unsupported_browser"),n.abrupt("return");case 23:if(m!==l.f.LocalStorageUnavailable){n.next=28;break}return k.k(c,"local_storage_unavailable"),n.abrupt("return");case 28:if(m!==l.f.NotAllRequiredAPIsSupported){n.next=31;break}return k.k(c,"not_all_push_apis_supported"),n.abrupt("return");case 31:if("denied"!==Notification.permission){n.next=35;break}return r(Object(l.p)()),k.k(c,"already_denied"),n.abrupt("return");case 35:if("granted"!==Notification.permission){n.next=39;break}return r(Object(l.q)()),r(M()),n.abrupt("return");case 39:if(g=localStorage.getItem("notification-permission-request-closed"),t||!g||"1"!==g){n.next=43;break}return k.k(c,"notification_permission_request_closed"),n.abrupt("return");case 43:if(j=localStorage.getItem(l.i),t||!j||j!==l.j){n.next=47;break}return k.k(c,"preprompt_closed"),n.abrupt("return");case 47:if(t||!d||Object(_.c)(c)){n.next=52;break}if(r(Object(l.s)()),!Object(x.c)(d)){n.next=52;break}return k.i(o()),n.abrupt("return");case 52:return r(Object(l.r)()),k.j(c),n.next=56,Notification.requestPermission();case 56:v=n.sent,n.t0=v,n.next="granted"===n.t0?60:"denied"===n.t0?64:67;break;case 60:return r(Object(l.q)()),r(M()),k.c(c),n.abrupt("break",70);case 64:return r(Object(l.p)()),k.d(c),n.abrupt("break",70);case 67:r(Object(l.p)()),k.e(c),localStorage.setItem("notification-permission-request-closed","1");case 70:case"end":return n.stop()}}),n)})));return function(e,t,r){return n.apply(this,arguments)}}()},M=function(e){return function(){var t=Object(o.a)(s.a.mark((function t(n,r,o){var a,c,u,l,f,m;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return a=r(),t.prev=1,t.next=4,navigator.serviceWorker.register("/sw.js");case 4:return c=t.sent,t.next=7,c.pushManager.getSubscription();case 7:if(u=t.sent){t.next=13;break}return l={userVisibleOnly:!0,applicationServerKey:d(i.a.pushNotificationApplicationServerKey)},t.next=12,c.pushManager.subscribe(l);case 12:u=t.sent;case 13:return Object(p.c)(),t.next=16,v(o.gqlContext(),r(),u);case 16:f=t.sent,m=f.body.data.registerWebPushToken,f.ok?m&&!m.ok?k.k(a,"registration_failed_in_gql"):(k.m(a),e&&n(Object(b.e)({kind:h.b.SuccessCommunity,text:Object(O.c)("Changes saved")}))):k.k(a,"registration_failed_generally"),t.next=25;break;case 21:t.prev=21,t.t0=t.catch(1),k.k(a,"registration_failed_uncaught_exception"),console.error(t.t0);case 25:case"end":return t.stop()}}),t,null,[[1,21]])})));return function(e,n,r){return t.apply(this,arguments)}}()},A=function(e){return function(){var t=Object(o.a)(s.a.mark((function t(n,r,o){var i,a;return s.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,navigator.serviceWorker.register("/sw.js");case 3:return i=t.sent,t.next=6,i.pushManager.getSubscription();case 6:(a=t.sent)&&(a.unsubscribe(),Object(p.c)(),e&&n(Object(b.e)({kind:h.b.SuccessCommunity,text:Object(O.c)("Changes saved")}))),t.next=12;break;case 10:t.prev=10,t.t0=t.catch(0);case 12:case"end":return t.stop()}}),t,null,[[0,10]])})));return function(e,n,r){return t.apply(this,arguments)}}()}},"./src/reddit/helpers/trackers/notifications.ts":function(e,t,n){"use strict";n.d(t,"j",(function(){return u})),n.d(t,"c",(function(){return d})),n.d(t,"d",(function(){return l})),n.d(t,"e",(function(){return p})),n.d(t,"i",(function(){return f})),n.d(t,"g",(function(){return b})),n.d(t,"h",(function(){return m})),n.d(t,"l",(function(){return j})),n.d(t,"m",(function(){return v})),n.d(t,"k",(function(){return k})),n.d(t,"b",(function(){return O})),n.d(t,"a",(function(){return S})),n.d(t,"f",(function(){return M}));n("./node_modules/core-js/modules/es6.object.assign.js");var r=n("./src/reddit/models/PushNotification/index.ts"),s=n("./src/reddit/selectors/telemetry.ts"),o=n("./src/telemetry/index.ts"),i=function(e){return Object.assign({},s.defaults(e),{noun:"desktop_notification_permissions"})},a=function(e){return Object.assign({},s.defaults(e),{noun:"desktop_notif_preprompt_permissions"})},c=function(e){return e?"enable":"disable"},u=function(e){Object(o.a)(Object.assign({},i(e),{action:"view",source:"popup"}))},d=function(e){Object(o.a)(Object.assign({},i(e),{action:"allow",source:"popup"}))},l=function(e){Object(o.a)(Object.assign({},i(e),{action:"block",source:"popup"}))},p=function(e){Object(o.a)(Object.assign({},i(e),{action:"close",source:"popup"}))},f=function(e){Object(o.a)(Object.assign({},a(e),{action:"view",source:"popup"}))},b=function(e){Object(o.a)(Object.assign({},a(e),{action:"allow",source:"popup"}))},m=function(e){Object(o.a)(Object.assign({},a(e),{action:"close",source:"popup"}))},g=function(e,t,n){return Object.assign({},s.defaults(e),{actionInfo:s.actionInfo(e,{success:t,reason:n}),noun:"push_token"})},j=function(e){Object(o.a)(Object.assign({},g(e,!0),{action:"request",source:"notification"}))},v=function(e){Object(o.a)(Object.assign({},g(e,!0),{action:"register",source:"notification"}))},k=function(e,t){Object(o.a)(Object.assign({},g(e,!1,t),{action:"bail",source:"notification"}))},O=function(e){return Object.assign({},function(e){return Object.assign({},s.defaults(e),{noun:"push_notification"})}(e),{notification:s.notification(e,void 0,void 0),action:void 0,source:"notification",correlationId:void 0})},h=function(e){return function(t,n){Object(o.a)(Object.assign({},s.defaults(t),{action:c(n),noun:e,source:"notification"}))}},x=h("chat_messages"),_=h("chat_requests"),w=h("comment_replies"),P=h("community_recs"),S=h("desktop_notification_permissions"),y=h("post_replies"),N=h("private_messages"),C=h("trending_posts"),D=h("username_mention"),I=h("upvotes_comment"),q=h("upvotes_post"),M=function(e,t,n){switch(t){case r.a.ChatMessages:x(e,n),_(e,n);break;case r.a.CommunityRecommendations:P(e,n);break;case r.a.TrendingPosts:C(e,n);break;case r.a.UpvotedComments:I(e,n);break;case r.a.UpvotedPosts:q(e,n);break;case r.a.UnreadMessages:w(e,n),y(e,n),N(e,n),D(e,n)}}},"./src/reddit/models/PushNotification/index.ts":function(e,t,n){"use strict";var r;n.d(t,"a",(function(){return r})),function(e){e.ChatMessages="chatMessages",e.CommunityRecommendations="communityRecommendations",e.TrendingPosts="trendingPosts",e.UnreadMessages="unreadMessages",e.UpvotedComments="upvotedComments",e.UpvotedPosts="upvotedPosts"}(r||(r={}))},"./src/reddit/selectors/experiments/dnPrePrompt.ts":function(e,t,n){"use strict";n.d(t,"a",(function(){return o})),n.d(t,"b",(function(){return i})),n.d(t,"c",(function(){return a}));var r=n("./src/reddit/constants/experiments.ts"),s=n("./src/reddit/helpers/chooseVariant/index.ts"),o=function(e){var t=Object(s.b)(e,{experimentEligibilitySelector:s.a,experimentName:r.B});return Object(r.Mb)(t)?void 0:t},i=function(e){return e===r.A.DarkPrePrompt||e===r.A.DarkSystemDialogue},a=function(e){return e===r.A.DarkPrePrompt||e===r.A.PrePrompt}}}]);
//# sourceMappingURL=Legacy~PushNotifications.4486cd35173d50eaf995.js.map